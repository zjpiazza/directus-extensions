apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: directus
  namespace: {{k8s-namespace TENANT_NAME ENVIRONMENT}}
spec:
  interval: 30m
  chart:
    spec:
      chart: directus
      version: ">=2.0.0 <3.0.0"
      sourceRef:
        kind: HelmRepository
        name: directus
        namespace: flux-system
  maxHistory: 2
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    adminEmail: {{default ADMIN_EMAIL ''}}
    createApplicationSecret: true
    createMysqlSecret: false
    createPostgresqlSecret: true
    databaseEngine: postgresql
    ingress:
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
      className: nginx
      enableTLS: true
      enabled: true
      hosts:
      - host: {{default HOSTNAME ''}}
        paths:
        - path: /
          pathType: Prefix
      tls:
      - hosts:
        - {{default HOSTNAME ''}}
        secretName: {{k8s-namespace TENANT_NAME ENVIRONMENT}}-directus-tls
    livenessProbe:
      enabled: true
      failureThreshold: 3
      httpGet:
        path: /
        port: http
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 1
    mysql:
      enableInstallation: false
    postgresql:
      auth:
        database: directus
        username: directus
        password: directus-password
      enableInstallation: true
      primary:
        persistence:
          enabled: true
          size: {{default STORAGE_SIZE '1Gi'}}
    readinessProbe:
      enabled: true
      failureThreshold: 3
      httpGet:
        path: /
        port: http
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 1
    redis:
      enabled: true
      replica:
        replicaCount: 0
    replicaCount: 1
    resources:
      limits:
        cpu: {{default CPU_LIMIT '500m'}}
        memory: {{default MEMORY_LIMIT '512Mi'}}
      requests:
        cpu: {{default CPU_REQUEST '100m'}}
        memory: {{default MEMORY_REQUEST '128Mi'}}
    startupProbe:
      enabled: true
      failureThreshold: 30
      httpGet:
        path: /
        port: http
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
